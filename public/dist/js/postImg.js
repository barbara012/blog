!function(){function t(t,e){this.update=function(){e.innerHTML=ME(markdown.toHTML(t.value))},t.editor=this,this.update()}function e(t,e){if(document.selection){var n=document.selection.createRange();n.text=e}else if("number"==typeof t.selectionStart&&"number"==typeof t.selectionEnd){var o=t.selectionStart,i=t.selectionEnd,s=o,a=t.value;t.value=a.substring(0,o)+e+a.substring(i,a.length),s+=e.length,t.selectionStart=t.selectionEnd=s}else t.value+=e}function n(t,e,n){if("undefined"==typeof FormData)throw new Error("FormData is not implemented");var i=new XMLHttpRequest,s=new FormData;for(var a in e)if(e.hasOwnProperty(a)){var r=e[a];"function"!=typeof r&&s.append(a,r)}i.onreadystatechange=function(){4===i.readyState&&n&&n(i)},i.upload.onprogress=function(t){t.lengthComputable&&o(t.loaded/t.total)},i.open("POST",t),i.send(s),p=1}function o(t){d.style.width=c.clientWidth*t+"px",1===t&&(c.style.display="none")}var i=$("#hidden"),s=document.getElementById("post"),a=($("#post-content"),$("#post-title"),$(".post-title_input"),$("#post-btn")),r=$("#post"),l=function(t,e,n){$.ajax({type:"POST",url:t,data:e,success:function(t){return 1===n&&void(3===t.type?(noty({text:t.mes,type:"success",timeout:2e3,killer:!1,dismissQueue:!0,layout:"topCenter"}),setTimeout(function(){location.href=t.url},2e3)):console.log("葫芦娃"))}})},u=function(t){return document.getElementById(t)};new t(u("post"),u("preview")),$(document).on({dragleave:function(t){t.preventDefault()},drop:function(t){t.preventDefault()},dragenter:function(t){t.preventDefault()},dragover:function(t){t.preventDefault()}});var c=document.getElementById("progress-container"),d=document.getElementById("progress-bar"),p=0;s.addEventListener("drop",function(o){if(o.preventDefault(),1!==p){var a=o.dataTransfer.files,r={},l="/post/"+i.val();if(0!==a.length&&a[0].type.indexOf("image")!==-1){if(a[0].size>2097152)return void alert("图片尺寸过大！服务器硬盘扛不住！");r.image=a[0],c.style.display="block",n(l,r,function(n){p=0,e(s,"![15]("+n.response+")"),new t(u("post"),u("preview"))})}}},!1);var f=0;a.click(function(t){if(""==r.val())return!1;if(1!==f){var e=$("#post").val(),n=$("#tag").val().replace(/(，)|(\t)|(,)|(-)|(\.)|(:)|(--)|(\s)|(：)|(。)|(\|)/g,";"),o=$("#title").val();post={},post.content=e,post.title=o?o:e.substr(0,10),post.tag=n,l(location.pathname,post,1),f=1}}),$("#tag").keydown(function(t){if(13===t.keyCode)return!1}),$(document).delegate("#post","keydown",function(t){var e=t.keyCode||t.which;if(9==e){t.preventDefault();var n=$(this).get(0).selectionStart,o=$(this).get(0).selectionEnd;$(this).val($(this).val().substring(0,n)+"\t"+$(this).val().substring(o)),$(this).get(0).selectionStart=$(this).get(0).selectionEnd=n+1}})}();var Preview=$.extend({},{init:function(){var t=$(".preview-container"),e=$(".editor-container"),n=this;$(".btn-preview").click(function(){t.hasClass("show")?(t.removeClass("show"),e.css("opacity",1)):($("#post")[0].editor.update(),t.css("height",n.getHeight(e)).addClass("show"),e.css("opacity",0))})},getHeight:function(t){return t.outerHeight()},enable:function(){this.init()}});